b73aebc added last logic and fixed tests
